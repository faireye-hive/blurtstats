<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blurt Rewards Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/modern-normalize/modern-normalize.css" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(180deg,#071127 0%, #071827 100%); color:#e6eef6; padding:24px}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;gap:16px;align-items:center;margin-bottom:20px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    input,select,button{background:#081226;border:1px solid #132033;color:var(--muted);padding:10px;border-radius:8px}
    button{cursor:pointer;color:#042; background:var(--accent); border: none}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .small{font-size:13px;color:var(--muted)}
    .chart-wrap{height:320px}
    ul.stats{list-style:none;padding:0;margin:0;display:flex;gap:12px}
    ul.stats li{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;flex:1;text-align:center}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .loading{opacity:0.8}
    .warn{color:#ffd580}
    .example{color:#9fc3ff;font-size:13px}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .legend .item{display:flex;gap:6px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Blurt Rewards Dashboard</h1>
      <div class="small">Últimos 30 dias — recompensas recebidas e estimativas de pending (próx. 7 dias)</div>
    </header>

    <div class="controls card">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label class="small">Conta:</label>
        <input id="accountInput" placeholder="ex: seuusuario" />
        <label class="small">RPC / nodo:</label>
        <input id="rpcInput" style="min-width:360px" value="https://rpc.blurt.world" placeholder="https://rpc.blurt.world (ou outro)" />
        <button id="fetchBtn">Buscar</button>
        <div style="margin-left:auto" class="example">Dica: aumente limite se tiver muitas postagens</div>
      </div>
      <div style="margin-top:8px" class="small">Este site usa as chamadas JSON-RPC da API "condenser_api" (get_account_history, get_discussions_by_blog, get_content). Configure o RPC caso o padrão não funcione.</div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Resumo (30 dias)</strong>
            <div class="small">Atualizado: <span id="updatedAt">—</span></div>
          </div>
          <ul class="stats" style="margin-top:12px">
            <li>
              <div class="small">Curation recebido</div>
              <div id="totalCuration" style="font-weight:700;font-size:18px">—</div>
            </li>
            <li>
              <div class="small">Author recebido</div>
              <div id="totalAuthor" style="font-weight:700;font-size:18px">—</div>
            </li>
            <li>
              <div class="small">Pending author (7d)</div>
              <div id="pendingAuthor" style="font-weight:700;font-size:18px">—</div>
            </li>
            <li>
              <div class="small">Estimated pending curation (7d)</div>
              <div id="pendingCuration" style="font-weight:700;font-size:18px">—</div>
            </li>
          </ul>

          <div style="margin-top:12px"><small class="small">Legenda</small>
            <div class="legend" style="margin-top:6px">
              <div class="item"><span class="dot" style="background:#60a5fa"></span> Curation</div>
              <div class="item"><span class="dot" style="background:#34d399"></span> Author</div>
              <div class="item"><span class="dot" style="background:#fbbf24"></span> Pending author (7d)</div>
            </div>
          </div>

          <div class="chart-wrap" style="margin-top:14px"><canvas id="rewardsChart" aria-label="gráfico de recompensas"></canvas></div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Logs</strong>
          <pre id="log" style="max-height:220px;overflow:auto;background:transparent;border:none;color:var(--muted)"></pre>
        </div>
      </div>

      <div>
        <div class="card">
          <strong>Config & detalhes</strong>
          <div class="small" style="margin-top:8px">Opções e notas técnicas</div>
          <ol class="small" style="margin-top:10px">
            <li>Busca histórico de operações (get_account_history) para extrair <code>curation_reward</code> e <code>author_reward</code>.</li>
            <li>Busca posts recentes via <code>get_discussions_by_blog</code> (limit configurable) e usa <code>get_content</code> para ler <code>pending_payout_value</code> e <code>cashout_time</code>.</li>
            <li>Estimativa de pending curation: usa fator de curation_ratio (padrão 25%). Isso é apenas uma estimativa — cálculo real depende dos votos e regras da rede.</li>
          </ol>

          <div style="margin-top:10px">
            <label class="small">Limite de posts (get_discussions_by_blog)</label>
            <input id="postLimit" type="number" min="10" max="200" value="100" />
          </div>

          <div style="margin-top:10px"><button id="exportCsv">Exportar CSV (30 dias)</button></div>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Como usar</strong>
          <ol class="small">
            <li>Informe sua conta e um RPC funcional.</li>
            <li>Clique em <em>Buscar</em>. Aguarde os requests (pode demorar se limite grande).</li>
            <li>Os gráficos serão preenchidos com as somas diárias dos últimos 30 dias.</li>
          </ol>
          <div style="margin-top:8px" class="warn">Aviso: dependendo do RPC, algumas chamadas podem falhar por limite de taxa — troque o endpoint se necessário.</div>
        </div>
      </div>
    </div>

    <footer class="small">Feito rápido — sinta-se livre para pedir ajustes (cores, fontes, algoritmo de estimativa etc.).</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // --- Utilitários ---
    const $ = id => document.getElementById(id);
    const fmt = (s) => s ? s.replace(/ BLURT| BLURT_POWER| BLURT\$| BLURT/g,'') : '0.000';

    function rpcCall(rpc, method, params) {
      return fetch(rpc, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({jsonrpc:'2.0', id:1, method, params})
      }).then(r => r.json()).then(j => {
        if (j.error) throw new Error(JSON.stringify(j.error));
        return j.result;
      });
    }

    function log(...t){ $('log').textContent += [...t].join(' ')+'\n'; }

    function toDateKey(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }

    // --- Main flow ---
    let chart;

    async function fetchAndRender(){
      const account = $('accountInput').value.trim();
      const rpc = $('rpcInput').value.trim() || 'https://rpc.blurt.world';
      const postLimit = parseInt($('postLimit').value,10) || 100;
      if(!account){ alert('Informe a conta.'); return; }
      $('updatedAt').textContent = 'Buscando...';
      $('log').textContent = '';

      try{
        log('RPC:', rpc);
        // 1) get_account_history recent ops (pegamos 1000 ops)
        log('Buscando account_history...');
        const history = await rpcCall(rpc, 'condenser_api.get_account_history', [account, -1, 1000]);
        log('ops recebidas:', history.length);

        const now = new Date();
        const daysMapCuration = {};
        const daysMapAuthor = {};
        for(let i=0;i<30;i++){ const d=new Date(); d.setDate(now.getDate()-i); const k=d.toISOString().slice(0,10); daysMapCuration[k]=0; daysMapAuthor[k]=0; }

        history.forEach(entry => {
          // entry = [index, [op_name, op_data]]
          try{
            const op = entry[1][0];
            const data = entry[1][1];
            if(op === 'curation_reward' || op === 'author_reward'){
              // ambos costumam ter 'reward' string e 'timestamp' ou usam block_time from global? We'll use timestamp if present else skip
              const rewardStr = data.reward || data.value || data.reward_steem || data.reward_blurt || data.rewards || '0.000 BLURT';
              // timestamp: some nodes include 'timestamp' or 'time' or use block info, fallback to now
              const ts = data.timestamp || data.time || entry[0] || new Date().toISOString();
              const key = toDateKey(ts);
              const val = parseFloat(fmt(rewardStr));
              if(op === 'curation_reward' && key in daysMapCuration) daysMapCuration[key] += val;
              if(op === 'author_reward' && key in daysMapAuthor) daysMapAuthor[key] += val;
            }
          }catch(e){ /* ignore entries we can't parse */ }
        });

        // totals
        const totalCuration = Object.values(daysMapCuration).reduce((a,b)=>a+b,0);
        const totalAuthor = Object.values(daysMapAuthor).reduce((a,b)=>a+b,0);

        $('totalCuration').textContent = totalCuration.toFixed(3) + ' BLURT';
        $('totalAuthor').textContent = totalAuthor.toFixed(3) + ' BLURT';

        // 2) pending author rewards: fetch recent posts by account and check cashout_time
        log('Buscando posts via get_discussions_by_blog...');
        const discussions = await rpcCall(rpc, 'condenser_api.get_discussions_by_blog', [{tag: account, limit: postLimit}]);
        log('posts obtidos:', discussions.length);

        const nowMs = Date.now();
        const sevenDaysMs = 7*24*60*60*1000;
        let pendingAuthorSum = 0;
        let pendingCurationEstimate = 0;

        // For each discussion, call get_content to read pending_payout_value and cashout_time
        for(const d of discussions){
          try{
            const content = await rpcCall(rpc, 'condenser_api.get_content', [d.author, d.permlink]);
            if(!content) continue;
            const pendingStr = content.pending_payout_value || content.pending_payout || '0.000 BLURT';
            const cashout = content.cashout_time || content.beneficiary_payout_value_time || content.last_payout; // fallback
            const pendingVal = parseFloat(fmt(pendingStr));
            const cashMs = new Date(cashout).getTime();
            if(!isNaN(cashMs) && cashMs > nowMs && (cashMs - nowMs) <= sevenDaysMs){
              pendingAuthorSum += pendingVal;
              // estimated curation portion (heuristic)
              const curationRatio = 0.25; // configuração
              pendingCurationEstimate += pendingVal * curationRatio;
            }
          }catch(e){ log('erro get_content', d.author, d.permlink, e.message); }
        }

        $('pendingAuthor').textContent = pendingAuthorSum.toFixed(3) + ' BLURT';
        $('pendingCuration').textContent = pendingCurationEstimate.toFixed(3) + ' BLURT (estim.)';

        // 3) prepare chart for last 30 days
        const labels = Object.keys(daysMapAuthor).sort();
        const dataAuthor = labels.map(l=>daysMapAuthor[l]);
        const dataCuration = labels.map(l=>daysMapCuration[l]);

        renderChart(labels, dataAuthor, dataCuration);

        $('updatedAt').textContent = new Date().toLocaleString();

      }catch(err){
        log('Erro geral:', err.message || err);
        alert('Erro: ' + (err.message || err));
        $('updatedAt').textContent = 'Erro';
      }
    }

    function renderChart(labels, authorData, curationData){
      const ctx = $('rewardsChart');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets:[
            {label:'Author received', data: authorData, tension:0.3, borderWidth:2, pointRadius:3, borderColor:'#34d399', backgroundColor:'rgba(52,211,153,0.06)'},
            {label:'Curation received', data: curationData, tension:0.3, borderWidth:2, pointRadius:3, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.06)'}
          ]
        },
        options:{scales:{y:{beginAtZero:true}}, plugins:{legend:{labels:{usePointStyle:true}}}}
      });
    }

    // CSV export
    function downloadCsv(){
      if(!chart) { alert('Execute a busca antes de exportar.'); return; }
      const labels = chart.data.labels;
      const aData = chart.data.datasets[0].data;
      const cData = chart.data.datasets[1].data;
      let csv = 'date,author,curation\n';
      for(let i=0;i<labels.length;i++) csv += `${labels[i]},${aData[i]},${cData[i]}\n`;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download = 'blurt_rewards_30d.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // --- events ---
    document.getElementById('fetchBtn').addEventListener('click', fetchAndRender);
    document.getElementById('exportCsv').addEventListener('click', downloadCsv);

    // prefill example (remova se preferir)
    $('accountInput').value = '';
    $('rpcInput').value = '';
  </script>
</body>
</html>
